<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<style>


</style>
	<link href="/css/header.css" rel="stylesheet" type="text/css">
</head>
<body>
<header class="header">
    <div class="container">
        <div class="row header-top"> 
         <div class="col logo">
 		<a href="/main">
        <img src="/images/logo2.png" alt="Logo" class="logo-img" width="120" height="auto"/>
		</a>
</div>
            <div class="col search-bar">
            
            
              <form id="stockSearchForm" action="/stocks" method="get">
    <input type="text" id="tickerInput" name="ticker" placeholder="티커 또는 회사를 입력해주세요">
    <button type="submit">Search</button>
</form>
				
            </div>
            <div class="col login">
    <button type="button" onclick="window.location.href='/login'">로그인</button>
	</div>
        </div>
        <nav class="menu">
            <ul>
                <li><a href="#">홈</a></li>
                <li><a href="#">서비스</a></li>
                <li><a href="#">고객센터</a></li>
                <li><a href="#">문의하기</a></li>
            </ul>
        </nav>
    </div>
</header>

<script th:inline="javascript">
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');

    // 차트 인스턴스가 이미 있는 경우 업데이트 하기
    let chart = null;  // 기존 차트 (차트를 갱신할 변수)

    // 검색 버튼 클릭 시 차트 데이터 갱신
    searchButton.addEventListener('click', function() {
        const ticker = searchInput.value.trim().toUpperCase();

        if (ticker) {
            fetchStockDataAndUpdateChart(ticker);
        } else {
            alert('티커를 입력해주세요.');
        }
    });

    // 티커에 맞는 데이터를 가져오는 함수
    function fetchStockDataAndUpdateChart(ticker) {
        const url = `/api/stock-data/stocks/${ticker}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                // 차트 데이터를 받고 갱신
                updateChart(data);
            })
            .catch(error => {
                console.error('데이터를 가져오는 데 실패했습니다:', error);
            });
    }

    // 차트를 갱신하는 함수
    function updateChart(stockData) {
        const ohlcData = stockData.map(stock => ({
            t: new Date(stock.date.replace(" ", "T")),   // Date or timestamp
            o: stock.open,   // Opening price
            h: stock.high,   // High price
            l: stock.low,    // Low price
            c: stock.close   // Closing price
        }));

        // 차트가 이미 존재한다면 업데이트
        if (chart) {
            chart.data.datasets[0].data = ohlcData;  // 기존 차트 데이터 업데이트
            chart.update();  // 차트 갱신
        } else {
            // 차트가 없다면 새로 생성
            createChart(ohlcData);
        }
    }

    // 차트를 새로 생성하는 함수
    function createChart(ohlcData) {
        const ctx = document.getElementById('myChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'OHLC',
                    data: ohlcData,
                    borderColor: 'rgb(75, 192, 192)',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        }
                    },
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }
</script>
</body>
</html>
