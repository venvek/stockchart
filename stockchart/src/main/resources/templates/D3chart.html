<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

<meta charset="UTF-8">
<link href="/css/footer.css" rel="stylesheet" type="text/css">
    <link href="/css/header.css" rel="stylesheet" type="text/css">

<title>svg d3</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
    .volume-bar {
      fill: rgba(0, 0, 255, 0.4);
    }

    .rsi-line {
      stroke: #333;
      fill: none;
      stroke-width: 2;
    }

    .rsi-threshold {
      stroke: red;
      stroke-dasharray: 4 2;
    }

    .rsi-zone {
      fill: rgba(255, 0, 0, 0.1);
    }

    .price-line {
      stroke: steelblue;
      fill: none;
      stroke-width: 2;
    }
  </style>
  
</head>

<body>

<div th:replace="CommonFile/header :: header"></div>


  <svg id="combined-chart" width="900" height="600"></svg>



<div th:replace="CommonFile/footer :: footer"></div>

<script th:inline="javascript">

const data = [
    { date: '2024-01-01', close: 120, volume: 1500000, rsi: 45 },
    { date: '2024-01-02', close: 122, volume: 1800000, rsi: 55 },
    { date: '2024-01-03', close: 119, volume: 1600000, rsi: 30 },
    { date: '2024-01-04', close: 125, volume: 2100000, rsi: 75 },
    { date: '2024-01-05', close: 124, volume: 2000000, rsi: 65 },
  ];

  const parseDate = d3.timeParse('%Y-%m-%d');
  data.forEach(d => d.date = parseDate(d.date));

  // 사이즈 설정
  const margin = { top: 10, right: 50, bottom: 30, left: 60 };
  const width = 800 - margin.left - margin.right;
  const heightMain = 300;
  const heightRSI = 150;
  const spacing = 50;
  const totalHeight = heightMain + heightRSI + spacing + margin.top + margin.bottom;

  const svg = d3.select("#combined-chart")
    .attr("width", width + margin.left + margin.right)
    .attr("height", totalHeight);

  const x = d3.scaleTime()
    .domain(d3.extent(data, d => d.date))
    .range([0, width]);

  const yPrice = d3.scaleLinear()
    .domain([d3.min(data, d => d.close) * 0.95, d3.max(data, d => d.close) * 1.05])
    .range([heightMain, 0]);

  const yVolume = d3.scaleLinear()
    .domain([0, d3.max(data, d => d.volume)])
    .range([heightMain, heightMain - 80]);

  const yRSI = d3.scaleLinear()
    .domain([0, 100])
    .range([heightRSI, 0]);

  // 📈 메인 차트 (가격, 볼륨)

  const mainGroup = svg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  mainGroup.append("text")
  .attr("x", 0)
  .attr("y", 5)
  .attr("font-size", "16px")
  .attr("font-weight", "bold")
  .text("가격");
  
  mainGroup.append("g")
    .attr("transform", `translate(0,${heightMain})`)
    .call(d3.axisBottom(x));

  mainGroup.append("g").call(d3.axisLeft(yPrice));

  const priceLine = d3.line()
    .x(d => x(d.date))
    .y(d => yPrice(d.close));

  mainGroup.append("path")
    .datum(data)
    .attr("class", "price-line")
    .attr("d", priceLine);
  

  mainGroup.selectAll(".volume-bar")
    .data(data)
    .enter()
    .append("rect")
    .attr("class", "volume-bar")
    .attr("x", d => x(d.date) - 5)
    .attr("y", d => yVolume(d.volume))
    .attr("width", 10)
    .attr("height", d => heightMain - yVolume(d.volume));


  // 📉 RSI 차트

  const rsiGroup = svg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top + heightMain + spacing})`);

  rsiGroup.append("text")
  .attr("x", 0)
  .attr("y", -10)
  .attr("font-size", "16px")
  .attr("font-weight", "bold")
  .text("종가 및 거래량");
  
  rsiGroup.append("g")
    .attr("transform", `translate(0,${heightRSI})`)
    .call(d3.axisBottom(x));

  rsiGroup.append("g").call(d3.axisLeft(yRSI));
  

  const rsiLine = d3.line()
    .x(d => x(d.date))
    .y(d => yRSI(d.rsi));

  rsiGroup.append("path")
    .datum(data)
    .attr("class", "rsi-line")
    .attr("d", rsiLine);

  // RSI 기준선
  rsiGroup.append("line")
    .attr("class", "rsi-threshold")
    .attr("x1", 0)
    .attr("x2", width)
    .attr("y1", yRSI(70))
    .attr("y2", yRSI(70));

  rsiGroup.append("line")
    .attr("class", "rsi-threshold")
    .attr("x1", 0)
    .attr("x2", width)
    .attr("y1", yRSI(30))
    .attr("y2", yRSI(30));
  

  // RSI 강조영역 (70 이상)
  rsiGroup.selectAll(".rsi-zone")
    .data(data.filter(d => d.rsi > 70))
    .enter()
    .append("rect")
    .attr("class", "rsi-zone")
    .attr("x", d => x(d.date) - 5)
    .attr("y", yRSI(100))
    .attr("width", 10)
    .attr("height", yRSI(70) - yRSI(100));
  
  const heightMACD = 150 - margin.top - margin.bottom;

  const yMACD = d3.scaleLinear()
    .domain([
      d3.min(data, d => Math.min(d.macd, d.signal, d.histogram)) * 1.1,
      d3.max(data, d => Math.max(d.macd, d.signal, d.histogram)) * 1.1
    ])
    .range([heightMACD, 0]);

  const svgMACD = d3.select("#macd-chart")
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  svgMACD.append("g")
    .attr("transform", `translate(0,${heightMACD})`)
    .call(d3.axisBottom(x));

  svgMACD.append("g").call(d3.axisLeft(yMACD));

  // 제목
  svgMACD.append("text")
    .attr("x", 0)
    .attr("y", -10)
    .attr("font-size", "16px")
    .attr("font-weight", "bold")
    .text("MACD 지표");

  // MACD 선
  const macdLine = d3.line()
    .x(d => x(d.date))
    .y(d => yMACD(d.macd));

  svgMACD.append("path")
    .datum(data)
    .attr("fill", "none")
    .attr("stroke", "blue")
    .attr("stroke-width", 1.5)
    .attr("d", macdLine);

  // Signal 선
  const signalLine = d3.line()
    .x(d => x(d.date))
    .y(d => yMACD(d.signal));

  svgMACD.append("path")
    .datum(data)
    .attr("fill", "none")
    .attr("stroke", "red")
    .attr("stroke-width", 1.5)
    .attr("d", signalLine);

  // Histogram
  svgMACD.selectAll(".macd-bar")
    .data(data)
    .enter()
    .append("rect")
    .attr("class", "macd-bar")
    .attr("x", d => x(d.date) - 5)
    .attr("y", d => yMACD(Math.max(0, d.histogram)))
    .attr("width", 10)
    .attr("height", d => Math.abs(yMACD(d.histogram) - yMACD(0)))
    .attr("fill", d => d.histogram >= 0 ? "green" : "orange");

  // 0선
  svgMACD.append("line")
    .attr("x1", 0)
    .attr("x2", width)
    .attr("y1", yMACD(0))
    .attr("y2", yMACD(0))
    .attr("stroke", "#888")
    .attr("stroke-dasharray", "4 2");
  

  
  
</script>
</body>

</html>