<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

<meta charset="UTF-8">
<link href="/css/footer.css" rel="stylesheet" type="text/css">
    <link href="/css/header.css" rel="stylesheet" type="text/css">

<title>svg d3</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
   .price-line {
  stroke: black;
  fill: none;
}

.volume-bar {
  fill: #bbb;
  opacity: 0.6;
}

.rsi-line {
  stroke: purple;
  fill: none;
}

.rsi-threshold {
  stroke: red;
  stroke-dasharray: 4;
}

.rsi-zone {
  fill: rgba(255, 0, 0, 0.2);
}

.macd-line {
  stroke-width: 2px;
}

.signal-line {
  stroke-width: 2px;
  stroke-dasharray: 4;
}
    
 .tooltip {
    position: absolute;
    background-color: white;
    border: 1px solid gray;
    padding: 8px;
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    border-radius: 4px;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
  }    
  </style>
  
</head>

<body>

<div th:replace="CommonFile/header :: header"></div>

<div id="tooltip" class="tooltip"></div>

<svg id="combined-chart" width="1500" height="1300"></svg>

<button id="switchData">Îã§Î•∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÌôò</button>



<div th:replace="CommonFile/footer :: footer"></div>

<script th:inline="javascript">

const data1 = [
	{ date: '2025-01-01', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19 },
	  { date: '2025-01-02', close: 21, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21 },
	  { date: '2025-01-04', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19 },
	  { date: '2025-01-05', close: 23, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21 },
	  { date: '2025-01-07', close: 26, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19 }
	];

	const data2 = [
		{ date: '2025-01-01', close: 120, ma: 118, volume: 1500000, rsi: 45, macd: 1.2, signal: 1.0, histogram: 0.2, obv: 1500000, stochK: 45, stochD: 50 },
		  { date: '2025-01-02', close: 122, ma: 119, volume: 1800000, rsi: 55, macd: 1.5, signal: 1.3, histogram: 0.2, obv: 3300000, stochK: 45, stochD: 50 },
		  { date: '2025-02-04', close: 119, ma: 120, volume: 1600000, rsi: 30, macd: 1.0, signal: 1.2, histogram: -0.2, obv: 1700000, stochK: 45, stochD: 50 },
		  { date: '2025-03-03', close: 119, ma: 117, volume: 1600000, rsi: 30, macd: 1.0, signal: 1.3, histogram: 0.1, obv: 1600000, stochK: 45, stochD: 50 },
		  { date: '2025-04-08', close: 119, ma: 122, volume: 1600000, rsi: 30, macd: 1.0, signal: 1.1, histogram: 0.2, obv: 1900000, stochK: 45, stochD: 50 }
	];

function drawCombinedChart(data) {
	  const parseDate = d3.timeParse('%Y-%m-%d');
	  data.forEach(d => d.date = parseDate(d.date));

	  const margin = { top: 30, right: 60, bottom: 30, left: 60 };
	  const width = 900;
	  const heightMain = 300;
	  const heightRSI = 100;
	  const heightMACD = 100;
	  const spacing = 30;
	  const heightOBV = 150;
	  const heightStoch = 150;
	  const totalHeight = heightMain + heightRSI + heightMACD + heightOBV + heightStoch + spacing * 4 + margin.top + margin.bottom;
	  
	  const svg = d3.select("#combined-chart")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", totalHeight);

	  svg.selectAll("*").remove(); // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞

	  const x = d3.scaleTime()
	    .domain(d3.extent(data, d => d.date))
	    .range([0, width]);

	  // ========== Ï¢ÖÍ∞Ä/Í±∞ÎûòÎüâ Ï∞®Ìä∏ ==========
	  const yPrice = d3.scaleLinear()
	    .domain([d3.min(data, d => d.close) * 0.95, d3.max(data, d => d.close) * 1.05])
	    .range([heightMain, 0]);

	  const yVolume = d3.scaleLinear()
	    .domain([0, d3.max(data, d => d.volume)])
	    .range([heightMain, heightMain - 60]);
	  
	  
	  
	  const mainGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top})`);

	  mainGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("üìà Ï¢ÖÍ∞Ä & Í±∞ÎûòÎüâ");

	  mainGroup.append("g")
	    .attr("transform", `translate(0,${heightMain})`)
	    .call(d3.axisBottom(x));
	  mainGroup.append("g").call(d3.axisLeft(yPrice));

	  const priceLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yPrice(d.close));
	  
	  const volumeLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yVolume(d.volume));

	mainGroup.append("path")
	  .datum(data)
	  .attr("class", "volume-line")
	  .attr("fill", "none")
	  .attr("stroke", "purple")
	  .attr("stroke-width", 2)
	  .attr("stroke-dasharray", "4,2") // Ï†êÏÑ†
	  .attr("d", volumeLine);

	  mainGroup.selectAll(".volume-bar")
	    .data(data)
	    .enter()
	    .append("rect")
	    .attr("x", d => x(d.date) - 3)
	    .attr("y", d => yVolume(d.volume))
	    .attr("width", 6)
	    .attr("height", d => heightMain - yVolume(d.volume))
	    .attr("fill", "lightgray");

	  // ========== RSI ==========
	  const yRSI = d3.scaleLinear().domain([0, 100]).range([heightRSI, 0]);
	  
	  const rsiGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top + heightMain + spacing})`);

	  rsiGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("üí° RSI");

	  rsiGroup.append("g")
	    .attr("transform", `translate(0,${heightRSI})`)
	    .call(d3.axisBottom(x));
	  rsiGroup.append("g").call(d3.axisLeft(yRSI));

	  const rsiLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yRSI(d.rsi));

	  rsiGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "purple")
	    .attr("stroke-width", 1.5)
	    .attr("d", rsiLine);

	  rsiGroup.append("line")
	    .attr("x1", 0)
	    .attr("x2", width)
	    .attr("y1", yRSI(70))
	    .attr("y2", yRSI(70))
	    .attr("stroke", "red")
	    .attr("stroke-dasharray", "4,2");

	  rsiGroup.append("line")
	    .attr("x1", 0)
	    .attr("x2", width)
	    .attr("y1", yRSI(30))
	    .attr("y2", yRSI(30))
	    .attr("stroke", "green")
	    .attr("stroke-dasharray", "4,2");

	  const yMACD = d3.scaleLinear()
	    .domain([
	      d3.min(data, d => Math.min(d.macd, d.signal, d.histogram)) * 1.1,
	      d3.max(data, d => Math.max(d.macd, d.signal, d.histogram)) * 1.1
	    ])
	    .range([heightMACD, 0]);

	  const macdGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top + heightMain + heightRSI + spacing * 2})`);

	  macdGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("üìä MACD");

	  macdGroup.append("g")
	    .attr("transform", `translate(0,${heightMACD})`)
	    .call(d3.axisBottom(x));
	  macdGroup.append("g").call(d3.axisLeft(yMACD));

	  const macdLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yMACD(d.macd));
	  
	  const signalLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yMACD(d.signal));
	  
	  const histogramLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yMACD(d.histogram))
	  .curve(d3.curveMonotoneX); // Î∂ÄÎìúÎü¨Ïö¥ Í≥°ÏÑ†

	macdGroup.append("path")
	  .datum(data)
	  .attr("class", "macd-histogram-line")
	  .attr("fill", "none")
	  .attr("stroke", "orange")
	  .attr("stroke-width", 2)
	  .attr("d", histogramLine);

	  macdGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "blue")
	    .attr("stroke-width", 1.5)
	    .attr("d", macdLine);

	  macdGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "orange")
	    .attr("stroke-width", 1.5)
	    .attr("d", signalLine);
	  
	  macdGroup.selectAll(".histogram-bar")
	    .data(data)
	    .enter()
	    .append("rect")
	    .attr("x", d => x(d.date) - 2)
	    .attr("y", d => d.histogram >= 0 ? yMACD(d.histogram) : yMACD(0))
	    .attr("width", 4)
	    .attr("height", d => Math.abs(yMACD(d.histogram) - yMACD(0)))
	    .attr("fill", d => d.histogram >= 0 ? "green" : "red");
	}

	drawCombinedChart(data1);

	document.getElementById("switchData").addEventListener("click", () => {
	  drawCombinedChart(data2);
	});
	
	const yOBV = d3.scaleLinear()
	  .domain(d3.extent(data, d => d.obv))
	  .range([heightOBV, 0]);
	
	const obvLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yOBV(d.obv));
	
	const obvGroup = svg.append("g")
	  .attr("transform", `translate(${margin.left}, ${margin.top + heightMain + spacing + heightRSI + spacing + heightMACD + spacing})`);

	obvGroup.append("text")
	  .attr("x", 0)
	  .attr("y", -10)
	  .attr("font-size", "16px")
	  .attr("font-weight", "bold")
	  .text("OBV");

	obvGroup.append("g")
	  .attr("transform", `translate(0,${heightOBV})`)
	  .call(d3.axisBottom(x));

	obvGroup.append("g")
	  .call(d3.axisLeft(yOBV));

	obvGroup.append("path")
	  .datum(data)
	  .attr("fill", "none")
	  .attr("stroke", "teal")
	  .attr("stroke-width", 2)
	  .attr("class", "obv-line")
	  .attr("d", obvLine);

	const yStoch = d3.scaleLinear()
	  .domain([0, 100])
	  .range([heightStoch, 0]);
	
	const stochGroup = svg.append("g")
	  .attr("transform", `translate(${margin.left}, ${margin.top + heightMain + spacing + heightRSI + spacing + heightMACD + spacing + heightOBV + spacing})`);

	stochGroup.append("text")
	  .attr("x", 0)
	  .attr("y", -10)
	  .attr("font-size", "16px")
	  .attr("font-weight", "bold")
	  .text("Stochastic");

	stochGroup.append("g")
	  .attr("transform", `translate(0,${heightStoch})`)
	  .call(d3.axisBottom(x));

	stochGroup.append("g")
	  .call(d3.axisLeft(yStoch));
	
	const stochKLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yStoch(d.stochK));

	const stochDLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yStoch(d.stochD));

	stochGroup.append("path")
	  .datum(data)
	  .attr("fill", "none")
	  .attr("stroke", "blue")
	  .attr("stroke-width", 2)
	  .attr("class", "stoch-k-line")
	  .attr("d", stochKLine);

	stochGroup.append("path")
	  .datum(data)
	  .attr("fill", "none")
	  .attr("stroke", "red")
	  .attr("stroke-width", 2)
	  .attr("class", "stoch-d-line")
	  .attr("d", stochDLine);
	
	[80, 20].forEach(level => {
		  stochGroup.append("line")
		    .attr("x1", 0)
		    .attr("x2", width)
		    .attr("y1", yStoch(level))
		    .attr("y2", yStoch(level))
		    .attr("stroke", "#ccc")
		    .attr("stroke-dasharray", "4 2");
		});
	
	const tooltip = d3.select("#tooltip");

	const focusLine = svg.append("line")
	  .attr("stroke", "gray")
	  .attr("stroke-dasharray", "3,3")
	  .attr("stroke-width", 1)
	  .style("opacity", 0);

	svg.append("rect")
	  .attr("transform", `translate(${margin.left},${margin.top})`)
	  .attr("width", width)
	  .attr("height", totalHeight - margin.top - margin.bottom)
	  .style("fill", "none")
	  .style("pointer-events", "all")
	  .on("mousemove", function (event) {
	    const [mx] = d3.pointer(event);
	    const dateX = x.invert(mx);

	    // Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎÇ†Ïßú Ï∞æÍ∏∞
	    const bisect = d3.bisector(d => d.date).left;
	    const index = bisect(data, dateX);
	    const d0 = data[index - 1], d1 = data[index];
	    const d = !d0 ? d1 : !d1 ? d0 : (dateX - d0.date > d1.date - dateX ? d1 : d0);

	    // ÏàòÏßÅ ÎùºÏù∏ ÏúÑÏπò
	    const lineX = x(d.date) + margin.left;
	    focusLine
	      .attr("x1", lineX)
	      .attr("x2", lineX)
	      .attr("y1", margin.top)
	      .attr("y2", totalHeight - margin.bottom)
	      .style("opacity", 1);

	    // Tooltip ÏúÑÏπò Î∞è ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
	    tooltip
	      .style("left", `${lineX + 10}px`)
	      .style("top", `${event.pageY - 40}px`)
	      .style("opacity", 1)
	      .html(`
	        <strong>${d3.timeFormat("%Y-%m-%d")(d.date)}</strong><br/>
	        Ï¢ÖÍ∞Ä: ${d.close}<br/>
	        Í±∞ÎûòÎüâ: ${d.volume}<br/>
	        RSI: ${d.rsi}<br/>
	        MACD: ${d.macd}<br/>
	        Signal: ${d.signal}<br/>
	        Histogram: ${d.histogram}
	      `);
	  })
	  .on("mouseleave", function () {
	    focusLine.style("opacity", 0);
	    tooltip.style("opacity", 0);
	  });
	
	function calculateMA(data, period = 5) {
		  const maData = [];
		  for (let i = 0; i < data.length; i++) {
		    if (i < period - 1) {
		      maData.push({ ...data[i], ma: null });
		      continue;
		    }
		    const sum = data.slice(i - period + 1, i + 1).reduce((acc, d) => acc + d.close, 0);
		    const avg = sum / period;
		    maData.push({ ...data[i], ma: avg });
		  }
		  return maData;
		}
	
	const dataWithMA = calculateMA(data);
	
	function calculateStochastic(data, period = 14, smoothK = 3, smoothD = 3) {
		  const result = [];

		  for (let i = 0; i < data.length; i++) {
		    if (i < period - 1) {
		      result.push({ ...data[i], k: null, d: null });
		      continue;
		    }

		    const slice = data.slice(i - period + 1, i + 1);
		    const low = d3.min(slice, d => d.low);
		    const high = d3.max(slice, d => d.high);

		    const k = ((data[i].close - low) / (high - low)) * 100;

		    result.push({ ...data[i], k, d: null }); // DÎäî ÎÇòÏ§ëÏóê
		  }

		  // Smooth K (3-day moving average of %K)
		  for (let i = 0; i < result.length; i++) {
		    if (i < period + smoothK - 2) continue;

		    const smoothKVal = d3.mean(result.slice(i - smoothK + 1, i + 1), d => d.k);
		    result[i].k = smoothKVal;
		  }

		  // Smooth D (3-day moving average of %D)
		  for (let i = 0; i < result.length; i++) {
		    if (i < period + smoothK + smoothD - 3) continue;

		    const smoothDVal = d3.mean(result.slice(i - smoothD + 1, i + 1), d => d.k);
		    result[i].d = smoothDVal;
		  }

		  return result;
		}
	
	
	    const dataWithStoch = calculateStochastic(data);
	    
	    const heightSTC = 100;
	    const ySTC = d3.scaleLinear().domain([0, 100]).range([heightSTC, 0]);

	    const stcGroup = svg.append("g")
	      .attr("transform", `translate(${margin.left},${margin.top + heightMain + spacing + heightRSI + spacing + heightOBV + spacing})`);

	    stcGroup.append("g")
	      .attr("transform", `translate(0,${heightSTC})`)
	      .call(d3.axisBottom(x));

	    stcGroup.append("g").call(d3.axisLeft(ySTC));

	    stcGroup.append("text")
	      .attr("x", 0)
	      .attr("y", -10)
	      .text("Stochastic Oscillator");
	
	    const kLine = d3.line()
	    .defined(d => d.k !== null)
	    .x(d => x(d.date))
	    .y(d => ySTC(d.k));

	  const dLine = d3.line()
	    .defined(d => d.d !== null)
	    .x(d => x(d.date))
	    .y(d => ySTC(d.d));

	  stcGroup.append("path")
	    .datum(dataWithStoch)
	    .attr("fill", "none")
	    .attr("stroke", "blue")
	    .attr("stroke-width", 1.5)
	    .attr("d", kLine);

	  stcGroup.append("path")
	    .datum(dataWithStoch)
	    .attr("fill", "none")
	    .attr("stroke", "red")
	    .attr("stroke-width", 1.5)
	    .attr("d", dLine);
	  
</script>
</body>

</html>