<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

<meta charset="UTF-8">
<link href="/css/footer.css" rel="stylesheet" type="text/css">
    <link href="/css/header.css" rel="stylesheet" type="text/css">

<title>svg d3</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
   .price-line {
  stroke: black;
  fill: none;
}

.volume-bar {
  fill: #bbb;
  opacity: 0.6;
}

.rsi-line {
  stroke: purple;
  fill: none;
}

.rsi-threshold {
  stroke: red;
  stroke-dasharray: 4;
}

.rsi-zone {
  fill: rgba(255, 0, 0, 0.2);
}

.macd-line {
  stroke-width: 2px;
}

.signal-line {
  stroke-width: 2px;
  stroke-dasharray: 4;
}
    
 .tooltip {
    position: absolute;
    background-color: white;
    border: 1px solid gray;
    padding: 8px;
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    border-radius: 4px;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
  }    
  </style>
  
</head>

<body>

<div th:replace="CommonFile/header :: header"></div>

<div id="tooltip" class="tooltip"></div>

<svg id="combined-chart" width="1200" height="900"></svg>
<button id="switchData">다른 데이터 전환</button>



<div th:replace="CommonFile/footer :: footer"></div>

<script th:inline="javascript">

const data1 = [
	  { date: '2025-01-01', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2 },
	  { date: '2025-01-02', close: 22, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2 },
	  { date: '2025-01-03', close: 19, volume: 160000, rsi: 30, macd: 1.0, signal: 1.2, histogram: -0.2 },
	  { date: '2025-01-04', close: 25, volume: 210000, rsi: 70, macd: 1.8, signal: 1.6, histogram: 0.2 },
	  { date: '2025-01-05', close: 24, volume: 200000, rsi: 60, macd: 1.6, signal: 1.7, histogram: -0.1 }
	];

	const data2 = [
	  { date: '2025-01-06', close: 21, volume: 140000, rsi: 38, macd: 1.1, signal: 0.9, histogram: 0.2 },
	  { date: '2025-01-07', close: 23, volume: 170000, rsi: 55, macd: 1.6, signal: 1.4, histogram: 0.2 },
	  { date: '2025-01-08', close: 20, volume: 165000, rsi: 32, macd: 1.2, signal: 1.3, histogram: -0.1 },
	  { date: '2025-01-09', close: 26, volume: 220000, rsi: 72, macd: 1.9, signal: 1.7, histogram: 0.2 },
	  { date: '2025-01-10', close: 25, volume: 210000, rsi: 61, macd: 1.7, signal: 1.8, histogram: -0.1 }
	];

function drawCombinedChart(data) {
	  const parseDate = d3.timeParse('%Y-%m-%d');
	  data.forEach(d => d.date = parseDate(d.date));

	  const margin = { top: 30, right: 60, bottom: 30, left: 60 };
	  const width = 900;
	  const heightMain = 300;
	  const heightRSI = 100;
	  const heightMACD = 100;
	  const spacing = 30;
	  const totalHeight = heightMain + heightRSI + heightMACD + spacing * 2 + margin.top + margin.bottom;

	  const svg = d3.select("#combined-chart")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", totalHeight);

	  svg.selectAll("*").remove(); // 기존 차트 제거

	  const x = d3.scaleTime()
	    .domain(d3.extent(data, d => d.date))
	    .range([0, width]);

	  // ========== 종가/거래량 차트 ==========
	  const yPrice = d3.scaleLinear()
	    .domain([d3.min(data, d => d.close) * 0.95, d3.max(data, d => d.close) * 1.05])
	    .range([heightMain, 0]);

	  const yVolume = d3.scaleLinear()
	    .domain([0, d3.max(data, d => d.volume)])
	    .range([heightMain, heightMain - 60]);

	  const mainGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top})`);

	  mainGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("📈 종가 & 거래량");

	  mainGroup.append("g")
	    .attr("transform", `translate(0,${heightMain})`)
	    .call(d3.axisBottom(x));
	  mainGroup.append("g").call(d3.axisLeft(yPrice));

	  const priceLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yPrice(d.close));
	  
	  const volumeLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yVolume(d.volume));

	mainGroup.append("path")
	  .datum(data)
	  .attr("class", "volume-line")
	  .attr("fill", "none")
	  .attr("stroke", "purple")
	  .attr("stroke-width", 2)
	  .attr("d", volumeLine);

	  mainGroup.selectAll(".volume-bar")
	    .data(data)
	    .enter()
	    .append("rect")
	    .attr("x", d => x(d.date) - 3)
	    .attr("y", d => yVolume(d.volume))
	    .attr("width", 6)
	    .attr("height", d => heightMain - yVolume(d.volume))
	    .attr("fill", "lightgray");

	  // ========== RSI ==========
	  const yRSI = d3.scaleLinear().domain([0, 100]).range([heightRSI, 0]);
	  const rsiGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top + heightMain + spacing})`);

	  rsiGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("💡 RSI");

	  rsiGroup.append("g")
	    .attr("transform", `translate(0,${heightRSI})`)
	    .call(d3.axisBottom(x));
	  rsiGroup.append("g").call(d3.axisLeft(yRSI));

	  const rsiLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yRSI(d.rsi));

	  rsiGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "purple")
	    .attr("stroke-width", 1.5)
	    .attr("d", rsiLine);

	  rsiGroup.append("line")
	    .attr("x1", 0)
	    .attr("x2", width)
	    .attr("y1", yRSI(70))
	    .attr("y2", yRSI(70))
	    .attr("stroke", "red")
	    .attr("stroke-dasharray", "4,2");

	  rsiGroup.append("line")
	    .attr("x1", 0)
	    .attr("x2", width)
	    .attr("y1", yRSI(30))
	    .attr("y2", yRSI(30))
	    .attr("stroke", "green")
	    .attr("stroke-dasharray", "4,2");

	  // ========== MACD ==========
	  const yMACD = d3.scaleLinear()
	    .domain([
	      d3.min(data, d => Math.min(d.macd, d.signal, d.histogram)) * 1.1,
	      d3.max(data, d => Math.max(d.macd, d.signal, d.histogram)) * 1.1
	    ])
	    .range([heightMACD, 0]);

	  const macdGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top + heightMain + heightRSI + spacing * 2})`);

	  macdGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("📊 MACD");

	  macdGroup.append("g")
	    .attr("transform", `translate(0,${heightMACD})`)
	    .call(d3.axisBottom(x));
	  macdGroup.append("g").call(d3.axisLeft(yMACD));

	  const macdLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yMACD(d.macd));
	  
	  const signalLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yMACD(d.signal));
	  
	  const macdHistogramLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yMACD(d.histogram));


	  macdGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "blue")
	    .attr("stroke-width", 1.5)
	    .attr("d", macdLine);

	  macdGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "orange")
	    .attr("stroke-width", 1.5)
	    .attr("d", signalLine);
	  
	macdGroup.append("path")
	  .datum(data)
	  .attr("class", "macd-histogram-line")
	  .attr("fill", "none")
	  .attr("stroke", "orange")
	  .attr("stroke-width", 2)
	  .attr("d", macdHistogramLine);

	  // histogram 막대
	  macdGroup.selectAll(".histogram-bar")
	    .data(data)
	    .enter()
	    .append("rect")
	    .attr("x", d => x(d.date) - 2)
	    .attr("y", d => d.histogram >= 0 ? yMACD(d.histogram) : yMACD(0))
	    .attr("width", 4)
	    .attr("height", d => Math.abs(yMACD(d.histogram) - yMACD(0)))
	    .attr("fill", d => d.histogram >= 0 ? "green" : "red");
	}

	drawCombinedChart(data1);

	document.getElementById("switchData").addEventListener("click", () => {
	  drawCombinedChart(data2);
	});
  
  
	const tooltip = d3.select("#tooltip");

	const focusLine = svg.append("line")
	  .attr("stroke", "gray")
	  .attr("stroke-dasharray", "3,3")
	  .attr("stroke-width", 1)
	  .style("opacity", 0);

	svg.append("rect")
	  .attr("transform", `translate(${margin.left},${margin.top})`)
	  .attr("width", width)
	  .attr("height", totalHeight - margin.top - margin.bottom)
	  .style("fill", "none")
	  .style("pointer-events", "all")
	  .on("mousemove", function (event) {
	    const [mx] = d3.pointer(event);
	    const dateX = x.invert(mx);

	    // 가장 가까운 날짜 찾기
	    const bisect = d3.bisector(d => d.date).left;
	    const index = bisect(data, dateX);
	    const d0 = data[index - 1], d1 = data[index];
	    const d = !d0 ? d1 : !d1 ? d0 : (dateX - d0.date > d1.date - dateX ? d1 : d0);

	    // 수직 라인 위치
	    const lineX = x(d.date) + margin.left;
	    focusLine
	      .attr("x1", lineX)
	      .attr("x2", lineX)
	      .attr("y1", margin.top)
	      .attr("y2", totalHeight - margin.bottom)
	      .style("opacity", 1);

	    // Tooltip 위치 및 내용 업데이트
	    tooltip
	      .style("left", `${lineX + 10}px`)
	      .style("top", `${event.pageY - 40}px`)
	      .style("opacity", 1)
	      .html(`
	        <strong>${d3.timeFormat("%Y-%m-%d")(d.date)}</strong><br/>
	        종가: ${d.close}<br/>
	        거래량: ${d.volume}<br/>
	        RSI: ${d.rsi}<br/>
	        MACD: ${d.macd}<br/>
	        Signal: ${d.signal}<br/>
	        Histogram: ${d.histogram}
	      `);
	  })
	  .on("mouseleave", function () {
	    focusLine.style("opacity", 0);
	    tooltip.style("opacity", 0);
	  });
  
</script>
</body>

</html>