<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

<meta charset="UTF-8">
<link href="/css/footer.css" rel="stylesheet" type="text/css">
    <link href="/css/header.css" rel="stylesheet" type="text/css">

<title>svg d3</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
   .price-line {
  stroke: black;
  fill: none;
}

.volume-bar {
  fill: #bbb;
  opacity: 0.6;
}

.rsi-line {
  stroke: purple;
  fill: none;
}

.rsi-threshold {
  stroke: red;
  stroke-dasharray: 4;
}

.rsi-zone {
  fill: rgba(255, 0, 0, 0.2);
}

.macd-line {
  stroke-width: 2px;
}

.signal-line {
  stroke-width: 2px;
  stroke-dasharray: 4;
}
    
 .tooltip {
    position: absolute;
    background-color: white;
    border: 1px solid gray;
    padding: 8px;
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    border-radius: 4px;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
  }    
  </style>
  
</head>

<body>

<div th:replace="CommonFile/header :: header"></div>

<h2> Ìã∞Ïª§ ÌöåÏÇ¨ </h2>

<div id="tooltip" class="tooltip"></div>

<svg id="combined-chart" width="900" height="700"></svg>

<button id="toggleCrosshair">Crosshair On/Off</button>

<button id="switchData">Îã§Î•∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÌôò</button>


<div th:replace="CommonFile/footer :: footer"></div>

<script th:inline="javascript">

let crosshairEnabled = false;

const data1 = [
	{ date: '2025-01-01', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1500000, stochK: 45, stochD: 45 , cci: 22 },
	  { date: '2025-01-02', close: 21, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 3300000, stochK: 45, stochD: 49 , cci: 35 },
	  { date: '2025-01-04', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1700000, stochK: 47, stochD: 57 , cci: 48 },
	  { date: '2025-01-05', close: 23, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 1600000, stochK: 49, stochD: 50 , cci: 75 },
	  { date: '2025-01-07', close: 26, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1900000, stochK: 45, stochD: 59 , cci: 59 }
	  ,{ date: '2025-01-10', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1500000, stochK: 45, stochD: 45, cci: 98  },
	  { date: '2025-01-12', close: 21, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 3300000, stochK: 45, stochD: 49, cci: 100 },
	  { date: '2025-01-14', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1700000, stochK: 47, stochD: 57, cci: -123 },
	  { date: '2025-01-15', close: 23, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 1600000, stochK: 49, stochD: 50 , cci: 93},
	  { date: '2025-01-17', close: 26, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1900000, stochK: 45, stochD: 59 , cci: 43}
	  ,{ date: '2025-01-20', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1500000, stochK: 45, stochD: 45, cci: -43 },
	  { date: '2025-01-22', close: 21, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 3300000, stochK: 45, stochD: 49, cci: 43 },
	  { date: '2025-01-24', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1700000, stochK: 47, stochD: 57, cci: -43},
	  { date: '2025-01-25', close: 23, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 1600000, stochK: 49, stochD: 50 , cci: 43},
	  { date: '2025-01-27', close: 26, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1900000, stochK: 45, stochD: 59, cci: 43 }
	  ,{ date: '2025-02-02', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1500000, stochK: 45, stochD: 45 , cci: 43},
	  { date: '2025-02-02', close: 21, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 3300000, stochK: 45, stochD: 49, cci: -43 },
	  { date: '2025-02-04', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1700000, stochK: 47, stochD: 57, cci: 83 },
	  { date: '2025-02-05', close: 23, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 1600000, stochK: 49, stochD: 50, cci: 53 },
	  { date: '2025-02-07', close: 26, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1900000, stochK: 45, stochD: 59 , cci: 43}
	  ,{ date: '2025-02-01', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1500000, stochK: 45, stochD: 45, cci: 63 },
	  { date: '2025-02-02', close: 21, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 3300000, stochK: 45, stochD: 49 , cci: 43},
	  { date: '2025-02-04', close: 20, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1700000, stochK: 47, stochD: 57, cci: -63 },
	  { date: '2025-02-05', close: 23, volume: 180000, rsi: 50, macd: 1.5, signal: 1.3, histogram: 0.2, high: 23, low: 21, obv: 1600000, stochK: 49, stochD: 50, cci: 38 },
	  { date: '2025-02-07', close: 26, volume: 150000, rsi: 40, macd: 1.2, signal: 1.0, histogram: 0.2, high: 21, low: 19, obv: 1900000, stochK: 45, stochD: 59, cci: -48 }
	  ,
	];

	const data2 = [
		{ date: '2026-01-01', close: 120, ma: 118, volume: 1500000, rsi: 45, macd: 1.2, signal: 1.0, histogram: 0.2, obv: 1500000, stochK: 39, stochD: 48, cci: 38 },
		  { date: '2026-01-02', close: 122, ma: 119, volume: 1800000, rsi: 55, macd: 1.5, signal: 1.3, histogram: 0.2, obv: 2300000, stochK: 40, stochD: 50, cci: 43 },
		  { date: '2026-01-04', close: 119, ma: 120, volume: 1600000, rsi: 30, macd: 1.0, signal: 1.2, histogram: -0.2, obv: 1900000, stochK: 42, stochD: 49, cci: 45 },
	      { date: '2026-01-08', close: 120, ma: 118, volume: 1500000, rsi: 45, macd: 1.2, signal: 1.0, histogram: 0.2, obv: 1500000, stochK: 39, stochD: 48, cci: 38 },
		  { date: '2026-02-01', close: 122, ma: 119, volume: 1800000, rsi: 55, macd: 1.5, signal: 1.3, histogram: 0.2, obv: 2300000, stochK: 40, stochD: 50, cci: 43 },
		  { date: '2026-02-02', close: 119, ma: 120, volume: 1600000, rsi: 30, macd: 1.0, signal: 1.2, histogram: -0.2, obv: 1900000, stochK: 42, stochD: 49, cci: 45 },
		  { date: '2026-02-07', close: 120, ma: 118, volume: 1500000, rsi: 45, macd: 1.2, signal: 1.0, histogram: 0.2, obv: 1500000, stochK: 39, stochD: 48, cci: 38 },
	      { date: '2026-03-02', close: 122, ma: 119, volume: 1800000, rsi: 55, macd: 1.5, signal: 1.3, histogram: 0.2, obv: 2300000, stochK: 40, stochD: 50, cci: 43 },
		  { date: '2026-03-04', close: 119, ma: 120, volume: 1600000, rsi: 30, macd: 1.0, signal: 1.2, histogram: -0.2, obv: 1900000, stochK: 42, stochD: 49, cci: 45 },	  
		  { date: '2026-03-13', close: 119, ma: 117, volume: 1600000, rsi: 30, macd: 1.0, signal: 1.3, histogram: 0.1, obv: 1800000, stochK: 44, stochD: 51, cci: 50 },
		  { date: '2026-04-08', close: 119, ma: 122, volume: 1600000, rsi: 30, macd: 1.0, signal: 1.1, histogram: 0.2, obv: 2000000, stochK: 45, stochD: 50, cci: 53 }
	];
	

	  d3.select("#toggleCrosshair").on("click", () => {
	    crosshairEnabled = !crosshairEnabled;

	    if (crosshairEnabled) {
	      crosshair.style("display", null); // Î≥¥Ïù¥Í≤å
	    } else {
	      crosshair.style("display", "none"); // Ïà®Í∏∞Í∏∞
	    }
	  });
	
	

function drawCombinedChart(data) {
 	
	
	  const parseDate = d3.timeParse('%Y-%m-%d');
	  data.forEach(d => d.date = parseDate(d.date));

	  const margin = { top: 30, right: 60, bottom: 30, left: 60 };
	  const width = 1400;
	  const heightMain = 200;
	  const heightRSI = 100;
	  const heightMACD = 100;
	  const spacing = 50;
	  const heightOBV = 100;
	  const heightStoch = 100;
	  const heightSTC = 100;
	  const heightCCI = 100
	  
	  const totalHeight = margin.top + heightMain + spacing +
      heightRSI + spacing +
      heightMACD + spacing +
      heightOBV + spacing +
      heightSTC + spacing +
      heightCCI + margin.bottom;

	  d3.select("#combined-chart").attr("height", totalHeight);
	  
	  
	  const svg = d3.select("#combined-chart")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", totalHeight);

	  svg.selectAll("*").remove(); // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞

	  const x = d3.scaleTime()
	    .domain(d3.extent(data, d => d.date))
	    .range([0, width]);
	  

	  // ========== Ï¢ÖÍ∞Ä/Í±∞ÎûòÎüâ Ï∞®Ìä∏ ==========
	  const yPrice = d3.scaleLinear()
	    .domain([d3.min(data, d => d.close) * 0.95, d3.max(data, d => d.close) * 1.05])
	    .range([heightMain, 0]);

	  const yVolume = d3.scaleLinear()
	    .domain([0, d3.max(data, d => d.volume)])
	    .range([heightMain, heightMain - 60]);
	  
	  
	  
	  const mainGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top})`);

	  mainGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("üìà Ï¢ÖÍ∞Ä & Í±∞ÎûòÎüâ");

	  mainGroup.append("g")
	    .attr("transform", `translate(0,${heightMain})`)
	    .call(d3.axisBottom(x));
	  mainGroup.append("g").call(d3.axisLeft(yPrice));

	  const priceLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yPrice(d.close));
	  
	  const volumeLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yVolume(d.volume));

	mainGroup.append("path")
	  .datum(data)
	  .attr("class", "volume-line")
	  .attr("fill", "none")
	  .attr("stroke", "purple")
	  .attr("stroke-width", 2)
	  .attr("stroke-dasharray", "4,2") // Ï†êÏÑ†
	  .attr("d", volumeLine);

	  mainGroup.selectAll(".volume-bar")
	    .data(data)
	    .enter()
	    .append("rect")
	    .attr("x", d => x(d.date) - 3)
	    .attr("y", d => yVolume(d.volume))
	    .attr("width", 6)
	    .attr("height", d => heightMain - yVolume(d.volume))
	    .attr("fill", "lightgray");
	  
	  let crosshairEnabled = false;
	  
	  const crosshair = svg.append("g")
	  .attr("class", "crosshair")
	  .style("display", "none");
	  
	  

	crosshair.append("line") // ÏÑ∏Î°úÏÑ†
	  .attr("id", "crosshairX")
	  .attr("stroke", "gray")
	  .attr("stroke-width", 1)
	  .attr("stroke-dasharray", "3,3")
	  .attr("y1", 0)
	  .attr("y2", totalHeight); // Ï†ÑÏ≤¥ Ï∞®Ìä∏ ÎÜíÏù¥ÎßåÌÅº

	crosshair.append("line") // Í∞ÄÎ°úÏÑ†
	  .attr("id", "crosshairY")
	  .attr("stroke", "gray")
	  .attr("stroke-width", 1)
	  .attr("stroke-dasharray", "3,3")
	  .attr("x1", 0)
	  .attr("x2", width);
	  
	svg.on("click", function(event) {
		  if (!crosshairEnabled) return;

		  const [mx, my] = d3.pointer(event, svg.node());
		  const xDate = x.invert(mx);
		  const yValue = y.invert(my);

		  crosshair.style("display", null);

		  crosshair.select(".crosshair-x")
		    .attr("x1", mx).attr("x2", mx)
		    .attr("y1", 0).attr("y2", heightMain);

		  crosshair.select(".crosshair-y")
		    .attr("x1", 0).attr("x2", width)
		    .attr("y1", my).attr("y2", my);

		  d3.select("#tooltip")
		    .style("left", `${event.pageX + 10}px`)
		    .style("top", `${event.pageY - 20}px`)
		    .style("display", "inline-block")
		    .html(`ÎÇ†Ïßú: ${d3.timeFormat("%Y-%m-%d")(xDate)}<br/>Í∞í: ${yValue.toFixed(2)}`);
		

		  
	});
	  
	  // ========== RSI ==========
	  const yRSI = d3.scaleLinear().domain([0, 100]).range([heightRSI, 0]);
	  
	  const rsiGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top + heightMain + spacing})`);

	  rsiGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("üí° RSI");

	  rsiGroup.append("g")
	    .attr("transform", `translate(0,${heightRSI})`)
	    .call(d3.axisBottom(x));
	  rsiGroup.append("g").call(d3.axisLeft(yRSI));

	  const rsiLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yRSI(d.rsi));

	  rsiGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "purple")
	    .attr("stroke-width", 1.5)
	    .attr("d", rsiLine);

	  rsiGroup.append("line")
	    .attr("x1", 0)
	    .attr("x2", width)
	    .attr("y1", yRSI(70))
	    .attr("y2", yRSI(70))
	    .attr("stroke", "red")
	    .attr("stroke-dasharray", "4,2");

	  rsiGroup.append("line")
	    .attr("x1", 0)
	    .attr("x2", width)
	    .attr("y1", yRSI(30))
	    .attr("y2", yRSI(30))
	    .attr("stroke", "green")
	    .attr("stroke-dasharray", "4,2");

	  const yMACD = d3.scaleLinear()
	    .domain([
	      d3.min(data, d => Math.min(d.macd, d.signal, d.histogram)) * 1.1,
	      d3.max(data, d => Math.max(d.macd, d.signal, d.histogram)) * 1.1
	    ])
	    .range([heightMACD, 0]);

	  const macdGroup = svg.append("g")
	    .attr("transform", `translate(${margin.left},${margin.top + heightMain + heightRSI + spacing * 2})`);

	  macdGroup.append("text")
	    .attr("x", 0)
	    .attr("y", -5)
	    .attr("font-size", "14px")
	    .attr("font-weight", "bold")
	    .text("üìä MACD");

	  macdGroup.append("g")
	    .attr("transform", `translate(0,${heightMACD})`)
	    .call(d3.axisBottom(x));
	  macdGroup.append("g").call(d3.axisLeft(yMACD));

	  const macdLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yMACD(d.macd));
	  
	  const signalLine = d3.line()
	    .x(d => x(d.date))
	    .y(d => yMACD(d.signal));
	  
	  const histogramLine = d3.line()
	  .x(d => x(d.date))
	  .y(d => yMACD(d.histogram))
	  .curve(d3.curveMonotoneX); // Î∂ÄÎìúÎü¨Ïö¥ Í≥°ÏÑ†

	macdGroup.append("path")
	  .datum(data)
	  .attr("class", "macd-histogram-line")
	  .attr("fill", "none")
	  .attr("stroke", "orange")
	  .attr("stroke-width", 2)
	  .attr("d", histogramLine);

	  macdGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "blue")
	    .attr("stroke-width", 1.5)
	    .attr("d", macdLine);

	  macdGroup.append("path")
	    .datum(data)
	    .attr("fill", "none")
	    .attr("stroke", "orange")
	    .attr("stroke-width", 1.5)
	    .attr("d", signalLine);
	  
	  macdGroup.selectAll(".histogram-bar")
	    .data(data)
	    .enter()
	    .append("rect")
	    .attr("x", d => x(d.date) - 2)
	    .attr("y", d => d.histogram >= 0 ? yMACD(d.histogram) : yMACD(0))
	    .attr("width", 4)
	    .attr("height", d => Math.abs(yMACD(d.histogram) - yMACD(0)))
	    .attr("fill", d => d.histogram >= 0 ? "green" : "red");
	  
		const yOBV = d3.scaleLinear()
		  .domain(d3.extent(data, d => d.obv))
		  .range([heightOBV, 0]);
		
		const obvLine = d3.line()
		  .x(d => x(d.date))
		  .y(d => yOBV(d.obv));
		
		const obvGroup = svg.append("g")
		  .attr("transform", `translate(${margin.left}, ${margin.top + heightMain + spacing + heightRSI + spacing + heightMACD + spacing})`);

		obvGroup.append("text")
		  .attr("x", 0)
		  .attr("y", -10)
		  .attr("font-size", "16px")
		  .attr("font-weight", "bold")
		  .text("OBV");

		obvGroup.append("g")
		  .attr("transform", `translate(0,${heightOBV})`)
		  .call(d3.axisBottom(x));

		obvGroup.append("g")
		  .call(d3.axisLeft(yOBV));

		obvGroup.append("path")
		  .datum(data)
		  .attr("fill", "none")
		  .attr("stroke", "teal")
		  .attr("stroke-width", 2)
		  .attr("class", "obv-line")
		  .attr("d", obvLine);

		const yStoch = d3.scaleLinear()
		  .domain([0, 100])
		  .range([heightStoch, 0]);
		
		const stochGroup = svg.append("g")
		  .attr("transform", `translate(${margin.left}, ${margin.top + heightMain + spacing + heightRSI + spacing + heightMACD + spacing + heightOBV + spacing})`);

		stochGroup.append("text")
		  .attr("x", 0)
		  .attr("y", -10)
		  .attr("font-size", "16px")
		  .attr("font-weight", "bold")
		  .text("Stochastic");

		stochGroup.append("g")
		  .attr("transform", `translate(0,${heightStoch})`)
		  .call(d3.axisBottom(x));

		stochGroup.append("g")
		  .call(d3.axisLeft(yStoch));
		
		const stochKLine = d3.line()
		  .x(d => x(d.date))
		  .y(d => yStoch(d.stochK));

		const stochDLine = d3.line()
		  .x(d => x(d.date))
		  .y(d => yStoch(d.stochD));

		stochGroup.append("path")
		  .datum(data)
		  .attr("fill", "none")
		  .attr("stroke", "blue")
		  .attr("stroke-width", 2)
		  .attr("class", "stoch-k-line")
		  .attr("d", stochKLine);

		stochGroup.append("path")
		  .datum(data)
		  .attr("fill", "none")
		  .attr("stroke", "red")
		  .attr("stroke-width", 2)
		  .attr("class", "stoch-d-line")
		  .attr("d", stochDLine);
		
		[80, 20].forEach(level => {
			  stochGroup.append("line")
			    .attr("x1", 0)
			    .attr("x2", width)
			    .attr("y1", yStoch(level))
			    .attr("y2", yStoch(level))
			    .attr("stroke", "#ccc")
			    .attr("stroke-dasharray", "4 2");
			});
		
		const yCCI = d3.scaleLinear()
		  .domain([-200, 200])
		  .range([heightCCI, 0]);
		
		// CCI Í∑∏Î£π 
		const cciGroup = svg.append("g")
  .attr("transform", `translate(${margin.left},${margin.top + heightMain + spacing + heightRSI + spacing + heightMACD + spacing + heightOBV + spacing + heightSTC + spacing})`);

		// Ï†úÎ™©
		cciGroup.append("text")
		  .attr("x", 0)
		  .attr("y", -10)
		  .attr("font-size", "16px")
		  .attr("font-weight", "bold")
		  .text("CCI (Commodity Channel Index)");

		// Ï∂ï
		cciGroup.append("g")
		  .attr("transform", `translate(0,${heightCCI})`)
		  .call(d3.axisBottom(x));

		cciGroup.append("g").call(d3.axisLeft(yCCI));

		const cciLine = d3.line()
		  .x(d => x(d.date))
		  .y(d => yCCI(d.cci));

		cciGroup.append("path")
		  .datum(data)
		  .attr("class", "cci-line")
		  .attr("fill", "none")
		  .attr("stroke", "purple")
		  .attr("stroke-width", 1.5)
		  .attr("d", cciLine);

		// Í∏∞Ï§ÄÏÑ† (¬±100, 0)
		[100, -100, 0].forEach(level => {
		  cciGroup.append("line")
		    .attr("x1", 0)
		    .attr("x2", width)
		    .attr("y1", yCCI(level))
		    .attr("y2", yCCI(level))
		    .attr("stroke", level === 0 ? "black" : "red")
		    .attr("stroke-dasharray", "4");
		});
		
		const tooltip = d3.select("#tooltip");

		const focusLine = svg.append("line")
		  .attr("stroke", "gray")
		  .attr("stroke-dasharray", "3,3")
		  .attr("stroke-width", 1)
		  .style("opacity", 0);

		svg.append("rect")
		  .attr("transform", `translate(${margin.left},${margin.top})`)
		  .attr("width", width)
		  .attr("height", totalHeight - margin.top - margin.bottom)
		  .style("fill", "none")
		  .style("pointer-events", "all")
		  .on("mousemove", function (event) {
		    const [mx] = d3.pointer(event);
		    const dateX = x.invert(mx);

		    // Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎÇ†Ïßú Ï∞æÍ∏∞
		    const bisect = d3.bisector(d => d.date).left;
		    const index = bisect(data, dateX);
		    const d0 = data[index - 1], d1 = data[index];
		    const d = !d0 ? d1 : !d1 ? d0 : (dateX - d0.date > d1.date - dateX ? d1 : d0);

		    // ÏàòÏßÅ ÎùºÏù∏ ÏúÑÏπò
		    const lineX = x(d.date) + margin.left;
		    focusLine
		      .attr("x1", lineX)
		      .attr("x2", lineX)
		      .attr("y1", margin.top)
		      .attr("y2", totalHeight - margin.bottom)
		      .style("opacity", 1);

		    // Tooltip ÏúÑÏπò Î∞è ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
		    tooltip
		      .style("left", `${lineX + 10}px`)
		      .style("top", `${event.pageY - 40}px`)
		      .style("opacity", 1)
		      .html(`
		        <strong>${d3.timeFormat("%Y-%m-%d")(d.date)}</strong><br/>
		        Ï¢ÖÍ∞Ä: ${d.close}<br/>
		        Í±∞ÎûòÎüâ: ${d.volume}<br/>
		        RSI: ${d.rsi}<br/>
		        MACD: ${d.macd}<br/>
		        Signal: ${d.signal}<br/>
		        Histogram: ${d.histogram}
		      `);
		  })
		  .on("mouseleave", function () {
		    focusLine.style("opacity", 0);
		    tooltip.style("opacity", 0);
		  });
	  
	  
		function mousemove(event) {
		    if (!crosshairEnabled) return;
		    const [mx, my] = d3.pointer(event);
		    d3.select("#crosshairX").attr("x1", mx).attr("x2", mx);
		    d3.select("#crosshairY").attr("y1", my).attr("y2", my);
		  }
		
		
		d3.select("#toggleCrosshair").on("click", () => {
		    crosshairEnabled = !crosshairEnabled;
		    if (!crosshairEnabled) {
		      crosshair.style("display", "none");
		    }
		  });
		
		
		
	}

	drawCombinedChart(data1);

	document.getElementById("switchData").addEventListener("click", () => {
	  drawCombinedChart(data2);
	});
	

	
	function calculateMA(data, period = 5) {
		  const maData = [];
		  for (let i = 0; i < data.length; i++) {
		    if (i < period - 1) {
		      maData.push({ ...data[i], ma: null });
		      continue;
		    }
		    const sum = data.slice(i - period + 1, i + 1).reduce((acc, d) => acc + d.close, 0);
		    const avg = sum / period;
		    maData.push({ ...data[i], ma: avg });
		  }
		  return maData;
		}
	
	const dataWithMA = calculateMA(data1);
	
	function calculateStochastic(data, period = 14, smoothK = 3, smoothD = 3) {
		  const result = [];

		  for (let i = 0; i < data.length; i++) {
		    if (i < period - 1) {
		      result.push({ ...data[i], k: null, d: null });
		      continue;
		    }

		    const slice = data.slice(i - period + 1, i + 1);
		    const low = d3.min(slice, d => d.low);
		    const high = d3.max(slice, d => d.high);

		    const k = ((data[i].close - low) / (high - low)) * 100;

		    result.push({ ...data[i], k, d: null }); // DÎäî ÎÇòÏ§ëÏóê
		  }

		  // Smooth K (3-day moving average of %K)
		  for (let i = 0; i < result.length; i++) {
		    if (i < period + smoothK - 2) continue;

		    const smoothKVal = d3.mean(result.slice(i - smoothK + 1, i + 1), d => d.k);
		    result[i].k = smoothKVal;
		  }

		  // Smooth D (3-day moving average of %D)
		  for (let i = 0; i < result.length; i++) {
		    if (i < period + smoothK + smoothD - 3) continue;

		    const smoothDVal = d3.mean(result.slice(i - smoothD + 1, i + 1), d => d.k);
		    result[i].d = smoothDVal;
		  }

		  return result;
		}
	
	
	    const dataWithStoch = calculateStochastic(data);
	    
	    document.getElementById("toggleCrosshair").addEventListener("click", () => {
	    	  crosshairEnabled = !crosshairEnabled;
	    	  if (!crosshairEnabled) {
	    	    d3.select(".crosshair-x").style("display", "none");
	    	    d3.select(".crosshair-y").style("display", "none");
	    	    d3.select("#tooltip").style("display", "none");
	    	  }
	    	});
	    
	  
</script>
</body>

</html>